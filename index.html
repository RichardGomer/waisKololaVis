<!DOCTYPE html>
<html>
    <head>
        <title>WAISFest</title>
        <script src="lib/jquery/jquery.js"></script>
        <script src="lib/jquery.backstretch.min.js"></script>
        
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="lib/d3/d3.layout.cloud.js"></script>
        
        <!--
        <script src="lib/sigma/sigma.min.js"></script>
        <script src="lib/sigma/plugins/sigma.plugins.animate.min.js"></script>
        <script src="lib/sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
        -->
        
        <script src="client/kolola.js"></script>
        
        <script src="js/slide.js"></script>
        <script src="js/slide_eventPhotos.js"></script>
        <script src="js/slide_peopleNames.js"></script>
        <script src="js/slide_collaboration.js"></script>
        <script src="js/slide_feature.js"></script>
        <script src="js/slide_impactType.js"></script>
        <script src="js/slide_connections.js"></script>
        <script src="js/slide_title.js"></script>
        
        <link href='http://fonts.googleapis.com/css?family=Raleway:400,600,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="stylesheet" type="text/css" href="css/circle.css" />
        
    </head>

    <body>
        <div id="video">RENDERING...</div>
        
        <script>
            
            
        var endpoint_url = "http://www.wsdtc.deimpact.org.uk/api/1/";
        var client = new KOLOLA(endpoint_url);

        var pres = new KVideo(126, document.getElementById('video'));
                
        function setup(data)
        {
            console.log("Data received - Creating slides");
            
            // Slide of names
            var ppl = new KSlide_nameList(data.people, data.events);
            pres.addSlide(ppl);
            
            // Types
            var types = new KSlide_impactType(data.events);
            pres.addSlide(types);
            
            // Collaboration network
            var collab = new KSlide_connections(data);
            pres.addSlide(collab);

            // Sort events into the interesting impact points ("features" / statements)
            
            var points = [22,21,23,10,13,16,18,17,9,26]; // The list of statements we care about
            console.log("Categorising events by features", points);
            
            var eventsByPoint = {};
            for (var i in data.events)
            {
                var e = data.events[i];
                
                // Now see if this event has an of the interesting points associated with it!
                // First one wins
                for(var k in points)
                {
                    var fid = points[k].toString();
                    
                    if(e.features.indexOf(fid) > -1)
                    {
                        if(typeof eventsByPoint[fid] === 'undefined')
                            eventsByPoint[fid] = [];
                        
                        eventsByPoint[fid].push(e);
                        break;
                    }
                }
            }
            console.log(eventsByPoint);
            
            console.log("Creating feature sections");
            // Process each point in turn
            for(var p in points)
            {
                pointID = points[p];
                
                // Look up the statement
                for(var j in self.fw)
                {
                    statement = self.fw[j];
                    
                    if(statement.featureid == pointID.toString())
                        break;
                }
                
                if(eventsByPoint[pointID].length < 1)
                {
                    console.log("Feature is empty", pointID);
                    continue;   
                }
                
                console.log("Creating feature", pointID, statement);
                
                
                
                // Add the point/statement title
                var title = new KSlide_title(statement.statement, 3000);
                pres.addSlide(title);
                
                // For each event in this point, add a slide if possible
                for(var i in eventsByPoint[pointID])
                {
                    var e = eventsByPoint[pointID][i];

                    // Show photos if possible
                    if (e.photos.length > 0)
                    {
                        var s = new KSlide_EventPhotos(e, data.people, 2500);
                        //console.log(s);
                        pres.addSlide(s);
                    }
                    // Otherwise try a reflection
                    // TODO

                    // Otherwise a video?
                    // TODO
                }
                
            }
        
            var then = function()
            {
                var slides =  pres.getSlides();
                
                console.log("READY!");
                
                // Make it loop!
                var show = function(){
                    pres.show(show); 
                }
                
                document.getElementById('video').innerHTML = "READY! Click to begin";
                
                document.body.onclick = function(){ show(); };
            }
            
            console.log("Rendering slides");
            pres.render(then); //function(){window.setTimeout(then,100);}); // setTimeout gets back into global scope
        }
        
        // Get all events and people
        var stage2 = function(fw){
            self.fw = fw; // Stash the framework
            console.log("Loading people + events");
            client.query('%', function(){}, function(){}, setup);
        };
            
        console.log("Loading framework");
        client.getFramework(stage2);
            
            
        
	</script>

    </body>
</html>
