<!DOCTYPE html>
<html>
    <head>
        <title>WAISFest</title>
        <script src="lib/jquery/jquery.js"></script>
        <script src="lib/d3/d3.js"></script>
        <script src="lib/d3/d3.layout.cloud.js"></script>
        <script src="lib/sigma/sigma.min.js"></script>
        <script src="lib/sigma/plugins/sigma.plugins.animate.min.js"></script>
        <script src="lib/sigma/plugins/sigma.layout.forceAtlas2.min.js"></script>
        <script src="client/kolola.js"></script>
        <script src="js/slide.js"></script>
        <script src="js/slide_eventPhotos.js"></script>
        <script src="js/slide_peopleNames.js"></script>
        <script src="js/slide_collaboration.js"></script>
        <script src="js/slide_feature.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Raleway:400,600,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="style.css" />
    </head>

    <body>
        <div id="video">RENDERING...</div>
        
        <script>
            
            
        var endpoint_url = "http://www.wsdtc.deimpact.org.uk/api/1/";
        var client = new KOLOLA(endpoint_url);

        var pres = new KVideo(client, document.getElementById('video'));

        function getCollabNet(events)
        {
            var edges = {};
            for (var i in events)
            {
                for(var p in events[i].people)
                {
                    var personid = events[i].people[p];

                    if (typeof edges[personid] === 'undefined')
                    {
                        edges[personid] = {};
                    }

                    for (var p2 in events[i].people)
                    {
                        var personid2 = events[i].people[p2];

                        if (typeof edges[personid][personid2] === 'undefined')
                        {
                            edges[personid][personid2] = 1;
                        }
                        else
                        {
                            edges[personid][personid2]++;
                        }
                    }
                }
            }

            return edges;
        }
                
        function setup(data)
        {
            console.log("Data received - Creating slides");
            
            // Slide of names
            var ppl = new KSlide_nameList(data.people);
            pres.addSlide(ppl);
            
            // Collaboration network
            var net = getCollabNet(data.events);
            var collab = new KSlide_collaboration(net, data.people);
            pres.addSlide(collab);

            // Event photos for events that have photos
            for (var i in data.events)
            {
                var e = data.events[i];

                if (e.photos.length > 0)
                {
                    var s = new KSlide_EventPhotos(e, 1000);
                    //console.log(s);
                    pres.addSlide(s);
                }
            }
        
            var then = function()
            {
                console.log("Dumping slides");
                var slides =  pres.getSlides();
                
                console.log(slides);
                for(var i in slides)
                {
                    document.body.appendChild(slides[i]);
                }
                
                console.log("ACTION!");
                
                pres.show(function(){pres.show()}); // Show, and repeat!
            }
            
            console.log("Rendering slides");
            pres.render(then); //function(){window.setTimeout(then,100);}); // setTimeout gets back into global scope
        }
        
        // Get all events and people
        console.log("Loading initial data");
        client.query('%', function(){}, function(){}, setup);
        
	</script>

    </body>
</html>
